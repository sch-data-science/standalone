[{"name":"app.R","content":"\nlibrary(shiny)\nlibrary(shinyWidgets)\nlibrary(DT)\nlibrary(sf)\nlibrary(leaflet)\nlibrary(stringr)\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(bslib)\nlibrary(bsicons)\nlibrary(shinyBS)\n\ntrials <- readRDS(\"/trials.RDS\")\n\n\n\nSiteStatus <- c(sort(unique(trials$STATUS)))\nPhase <- c(\"Phase 1\", \"Phase 2\", \"Phase 3\", \"Phase 4\") \nStudyState <- c(sort(unique(trials$STATE)))\nStudyCity <- c(sort(unique(trials$CITYSTATE)))\n\nui <- fluidPage(\n\n  titlePanel(\n    fluidRow(\n      column(2, HTML('<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://www.seattlechildrens.org/\"><img src = \"logo.jpg\" height = 100><\/a>')),\n      column(10,HTML(\"Clinical Trials Near Me<br><small>Interventional studies in the United States of America with at least one site/location currently recuriting.<br>\n                     Data last refreshed \",\n                     format(as.Date(trials$LATEST_REFRESH[1]),format = \"%m/%d/%Y\"),\"<\/small>\"))),windowTitle=\"Clinical Trials Near Me\"),\n  \n  # Create a new Row in the UI for selectInputs\n  tabsetPanel(type=\"tabs\",\n              tabPanel(\"Main\",\n                       fluidRow(\n                         column(2,\n                                bsTooltip(\"Age_input_a\",\n                                          \"Age in years\",\n                                          placement = \"right\", trigger = \"hover\"),\n                                \n                                numericInput(\n                                  \"Age_input\",\n                                  label=tagList(\n                                    \"Enter Participant Age\",\n                                    tags$span(\n                                      icon(\"question-circle\"),\n                                      id = \"Age_input_a\",\n                                      style = \"margin-left: 5px; cursor: pointer; color: #1c9ed8;\"\n                                    )\n                                  ),\n                                  value=18\n                                ),\n                                \n                                bsTooltip(\"SiteStatus_input_a\",\n                                          \"Not all sites for a Clinical Trial are actively recruiting\",\n                                          placement = \"right\", trigger = \"hover\"),\n                                \n                                pickerInput(\"SiteStatus_input\", \n                                            label=tagList(\n                                              \"Site Status\",\n                                              tags$span(\n                                                icon(\"question-circle\"),\n                                                id = \"SiteStatus_input_a\",\n                                                style = \"margin-left: 5px; cursor: pointer; color: #1c9ed8;\"\n                                              )\n                                            ),\n                                            SiteStatus, selected=\"RECRUITING\",\n                                            multiple=TRUE,\n                                            options = list(\n                                              \"title\" = 'Click to see options',\n                                              'actions-box'= TRUE\n                                            )\n                                ),\n                                \n                                bsTooltip(\"Phase_input_a\",\n                                          title=HTML(\"<ul><li>Phase 1 trials focus on safety and dosage.<\/li><li>Phase 2 trials focus on effectiveness, side effects, and dosage.<\/li><li>Phase 3 trials compare effectiveness to standard treatments.<\/li><li>Phase 4 trials examine long-term benefits and side effects.<\/li><\/ul>\"),\n                                          placement = \"right\", trigger = \"hover\"),\n                                \n                                pickerInput(\"Phase_input\", \n                                            label=tagList(\n                                              \"Phase\",\n                                              tags$span(\n                                                icon(\"question-circle\"),\n                                                id = \"Phase_input_a\",\n                                                style = \"margin-left: 5px; cursor: pointer; color: #1c9ed8;\"\n                                              )\n                                            ),\n                                            Phase, selected=Phase,\n                                            multiple=TRUE,\n                                            options = list(\n                                              \"title\" = 'Click to see options',\n                                              'actions-box'= TRUE\n                                            )\n                                ),\n                                HTML(\"<br>\"),\n                                textOutput(\"NLocations\"),\n                                textOutput(\"NStudies\")\n                                \n                         ),\n                         column(3,\n                                bsTooltip(\"Condition_search_a\",\n                                          \"Select the Clinical Trials whose Brief Title, Brief Summary, Keyword, and Conditions information contains ALL the words entered below\",\n                                          placement = \"right\", trigger = \"hover\"),\n                                \n                                textInput(\"Condition_search\",\n                                          \n                                          label=tagList(\n                                            \"Search Specific Words\",\n                                            tags$span(\n                                              icon(\"question-circle\"),\n                                              id = \"Condition_search_a\",\n                                              style = \"margin-left: 5px; cursor: pointer; color: #1c9ed8;\"\n                                            )\n                                          ))\n                                \n                         ),\n                         column(2,\n                                pickerInput(\"State_input\", \"State Select\",\n                                            StudyState, selected=StudyState,\n                                            multiple=TRUE,\n                                            options = list(\n                                              \"title\" = 'Click to see options',\n                                              'actions-box'= TRUE\n                                            )\n                                ),\n                                pickerInput(\"City_input\", \"City Select\",\n                                            StudyCity, selected=\"All\",\n                                            multiple=TRUE,\n                                            options = list(\n                                              \"title\" = 'Click to see options',\n                                              'actions-box'= TRUE\n                                            )\n                                ),\n                                \n                         ),\n                         column(5,HTML(\"<b>Select broadest State and Cities to the left, then Drag and Zoom to further refine your search<\/b>\")),\n                         column(5,leafletOutput('map'))\n                       ),\n                       \n                       \n                       # Create a new row for the table.\n                       HTML(\"Please click the 'Study URL' link below for more details and contact information for that particular study\"),\n                       HTML(\"<br>\"),\n                       div(DT::DTOutput(\"table\"), style = \"font-size:80%\")\n              ),\n              tabPanel(\"Read Me\",\n                       HTML(\"<br>\"),\n                       HTML(\"This app is based on the work of Andrew Cooper, Gayle Garson, Arpit Jain, Tyler Ketterl, Amy Wilcox at <a target='_blank' rel='noopener noreferrer' href='https://www.seattlechildrens.org/'>Seattle Children's Hospital<\/a>.\"),\n                       HTML(\"For Clinical Trails available at Seattle Children's Hospital please see our <a target='_blank' rel='noopener noreferrer' href='https://www.seattlechildrens.org/research/research-studies-clinical-trials/'> Clinical Trials and Research Studies Web Hub<\/a>.\"),\n                       HTML(\"<br>\"),\n                       HTML(\"<br>\"),\n                       HTML(\"The information provided on this dashboard is intended for general informational purposes only. It is designed to give an overview of clinical trial opportunities available within the US. While we strive to ensure the accuracy and timeliness of the information, it is important to discuss any clinical trial options with your healthcare provider before making any decisions. Participation in clinical trials is voluntary, and eligibility may vary based on individual health conditions and medical history. Please consult with your medical team for personalized advice regarding clinical trial opportunities. Except for minor geo-coding edits, data presented here is as-is from <a target='_blank' rel='noopener noreferrer' href='http://clinicaltrials.gov'>Clinicaltrials.gov<\/a>\"),\n                       HTML(\"<br>\"),\n                       HTML(\"<br>\"),\n                       HTML(\"Data source: <a target='_blank' rel='noopener noreferrer' href='http://clinicaltrials.gov'>Clinicaltrials.gov<\/a> API.<br>\"),\n                       HTML(\"<br>\"),\n                       HTML(\"Map provided by <a target='_blank' rel='noopener noreferrer' href='https://www.openstreetmap.org/copyright'>OpenStreetMap<\/a> under their  Creative Commons Attribution-ShareAlike 2.0 license (CC BY-SA 2.0).<br>\n                            Geocoding provided by <a target='_blank' rel='noopener noreferrer' href='https://docs.mapbox.com/api/search/geocoding/'>Mapbox Geocoding API<\/a>. <br>To contact Mapbox and OpenStreetMap to suggest improvements to the map, itself, <strong><a href='https://apps.mapbox.com/feedback/' target='_blank'>Please click here<\/a><\/strong>\"),\n                       HTML(\"<br>\"),\n                       HTML(\"<br>\"),\n                       HTML(\"For technical questions about this page, please contact:  Andrew.Cooper@SeattleChildrens.Org\"),\n                       HTML(\"<br>\"),\n                       HTML(\"For information regarding Seattle Children's Hospital, please visit <a target='_blank' rel='noopener noreferrer' href='https://www.seattlechildrens.org/'>our web page<\/a>.\"),\n                       HTML(\"<br>\"),\n                       HTML(\"<br>\"),\n                       HTML(\"Code for this app can be downloaded or forked from the <a target='_blank' rel='noopener noreferrer' href='https://github.com/sch-data-science/'>Seattle Children's Hospital Data Science GitHub page<\/a>.\"),\n                       HTML(\"<br>\"),\n                       HTML(\"An example that customizes this app for Diabetes-related clinical trials can be found <a target='_blank' rel='noopener noreferrer' href='https://schdatascience-find-diabetes-related-clinical-trials-near-me.share.connect.posit.cloud/'>HERE<\/a> with the associated code and directions for how to motify the app found on\n                            <a target='_blank' rel='noopener noreferrer' href='https://github.com/sch-data-science/'>Seattle Children's Hospital Data Science GitHub page<\/a>.\")\n                       \n              )))\n\nserver <- function(input, output,session) {\n  \n  #session <- sessionInfo()\n  #version <- paste0(session$R.version$major,\".\",session$R.version$minor)\n  \n  observeEvent(input$State_input,{\n    xx <- trials %>% filter(STATE %in% input$State_input) %>% dplyr::select(CITYSTATE) %>% unique()  %>% data.frame()\n    \n    # Can also set the label and select items\n    updatePickerInput(session=session, inputId = \"City_input\",\n                      choices = c(sort(xx$CITYSTATE)),\n                      selected = xx$CITYSTATE\n    )\n  }) \n  \n  MyData <- reactive({\n    data <- trials\n    \n    data <- data[data$STATUS %in% input$SiteStatus_input & \n                   \n                   str_detect(data$PHASE,paste(input$Phase_input, collapse = \"|\")) == TRUE &\n                   data$STATE %in% input$State_input &\n                   data$CITYSTATE %in% input$City_input\n                 ,]\n    data <- data %>% filter(input$Age_input >= MINAGE & input$Age_input<=MAXAGE)\n    \n    # Try something like this paste(input$Phase_input, collapse = \"|\")) and add title search\n    \n\n    \n    if(!(input$Condition_search %in% c(NULL, NA, \" \",\"\"))) {\n      data <- data %>% filter(rowSums(sapply(\n        unlist(str_split(trimws(input$Condition_search,which=\"right\"),pattern=\" \")),\n        str_detect,\n        string = tolower(paste(CONDITION,KEYWORD,BRIEFSUMMARY,BRIEFTITLE)))) == \n          length(unlist(str_split(trimws(input$Condition_search,which=\"right\"),pattern=\" \"))))\n    }\n    \n    \n    \n    data <- data %>% mutate(AGE_RANGE = paste0(MINAGE,\"-\",MAXAGE),\n                            STUDYURL = paste0(\"<a target='_blank' rel='noopener noreferrer' href = '\",STUDYURL,\"'>\",STUDYURL,\"<\/a>\"))\n    \n    data\n  })\n  \n  \n  MapData = reactive({\n    \n    MyData() %>% group_by(CITY,GEOPOINT.LAT,GEOPOINT.LON) %>% summarize(ntrials = n()) \n    \n    \n  })\n  \n  output$map = renderLeaflet({\n    leaflet() %>% addTiles() %>%\n      addCircleMarkers(MapData()$GEOPOINT.LON,MapData()$GEOPOINT.LAT,radius=3,\n                       popup=paste0(MapData()$CITY,\", \",MapData()$ntrials,\" trials\")) \n  })\n  \n  # A reactive expression that returns the set of zips that are\n  # in bounds right now\n  dataInBounds <- reactive({\n    if (is.null(input$map_bounds))\n      return(data[FALSE,])\n    bounds <- input$map_bounds\n    latRng <- range(bounds$north, bounds$south)\n    lngRng <- range(bounds$east, bounds$west)\n    \n    subset(MyData(),\n           GEOPOINT.LAT >= latRng[1] & GEOPOINT.LAT <= latRng[2] &\n             GEOPOINT.LON >= lngRng[1] & GEOPOINT.LON <= lngRng[2])\n  })\n  \n  \n  output$NLocations <- renderText({\n    paste0(\"Sites Selected: \",length(unique(dataInBounds()$FACILITY)))})\n  \n  output$NStudies <- renderText({\n    paste0(\"Studies Selected: \",length(unique(dataInBounds()$ORG_STUDY_ID)))})\n  \n  output$table <- DT::renderDataTable(DT::datatable({\n    temp <- dataInBounds() \n    temp <- temp %>% dplyr::select(ORG_STUDY_ID,BRIEFTITLE,FACILITYLOC,STATUS,PHASE,STUDYURL,AGE_RANGE,CONDITION)\n    names(temp) <- c(\"Study ID\", \"Study Title\",\"Study Site\",\"Site Status\",\"Phase\",\"Study URL\", \"Age Range\",\"Condition(s)\")\n    temp\n  }, escape = FALSE ,options = list(dom = 'ltp')\n  \n  ))\n}\n\n\nshinyApp(ui = ui, server = server)","type":"text"}]
